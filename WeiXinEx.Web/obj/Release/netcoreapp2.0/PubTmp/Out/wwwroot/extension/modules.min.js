var builder={list:[],register:function(n,t){builder.list.push({priority:t,init:n})},initialization:function(){builder.list.order(function(n){return n.priority}).forEach(function(n){n.init()})}},monitorMessages={init:function(){var n=MCS.cgiData.sessions.kfsession_and_msgsummary.select(function(n){return{useruin:n.kfsession.fans_uin,nickname:n.kfsession.nickname,openid:n.kfsession.fans_openid,sessionid:n.kfsession.session_id,msgid:n.msgsummary.msg.msgid}});client.pushSessions(n,function(n){n.forEach(function(n){monitorMessages.sendData(n.useruin,n.msgid+1)})})},sendData:function(n,t,i,r){i=i||20;plug.getFansMessageList(n,t,i,function(t){var f=r||!0,u;t.length!==0&&(t.length<i&&(f=!1),u=t.select(function(n){return{msgid:n.msgid,bizuin:n.bizuin,useruin:n.useruin,kfuin:n.kfuin,createtime:n.createtime,content:n.content,msgtype:n.msgtype,type:n.type,kf_openid:n.kf_openid}}),server("messages",{messages:u},function(t){if(t.count<u.length&&(f=!1),f){var i=u.min(function(n){return n.msgid});monitorMessages.sendData(n,i)}}))})}},monitorStatistic,monitorSession,filter,autoReply;$.extend(plug,{getFansMessageList:function(n,t,i,r){var u={fansuin:n,count:i||20};t>0&&(u.msgid=t);plug.get("/cgi-bin/kfmsg?action=getfansmsglist",u,function(n){r(n.msglist)})}});builder.register(monitorMessages.init,10);monitorStatistic={timer:null,init:function(){monitorStatistic.sendRange(client.settings.monitorStatisticRange||30);monitorStatistic.start()},start:function(){var n=(new Date).Date(),t=n.addDay(1),i=n.getTime()/1e3,r=t.getTime()/1e3;monitorStatistic.timer=setInterval(()=>{monitorStatistic.sendData(i,r)},client.settings.monitorStatisticInterval||3e4)},sendRange:function(n){var t=(new Date).Date(),i=t.addDay(-n),r=i.getTime()/1e3,u=t.getTime()/1e3;monitorStatistic.sendData(r,u)},sendData:function(n,t){plug.getStatistic(n,t,function(n){for(var t,u,i=[],r=0;r<n.length;r++)t=n[r],i.push({date:t.date,kf_uin:t.kf_uin,bizuin:client.current.bizuin,online_time:t.stat_data.online_time,session_count:t.stat_data.session_count,msg_send:t.stat_data.msg_send,msg_recv:t.stat_data.msg_recv});u=client.monitorData.session;client.monitorData.session={request:0,created:0,success:0,createdUsers:[],successUsers:[]};i={bizuin:client.current.bizuin,kfuin:client.current.kfuin,statistics:i,sessions:u};console.log(i);server("statistic",i)})}};$.extend(plug,{getStatistic:function(n,t,i){var r={};n>0&&(r.start_time=n);t>0&&(r.end_time=t);plug.get("/cgi-bin/kfstat?action=getstat",r,function(n){i(n.stat_list)})}});builder.register(monitorStatistic.init,10);monitorSession={isEnable:!0,timer:null,data:{request:0,users:0,success:0},start:function(){monitorSession.isEnable&&(monitorSession.timer||(client.settings.monitorInterval>0?monitorSession.timer=setInterval(monitorSession.unAccepted,client.settings.monitorInterval):monitorSession.unAccepted()))},unAccepted:function(){plug.getUnAccepted(function(n,t){if(client.monitorData.session.request++,n.length>0){var i=n.select(function(n){return n.msg.useruin});i.length>1?plug.createSession(i.join(","),!0,monitorSession.created):plug.createSession(i[0],!1,monitorSession.created);client.monitorData.session.created+=i.length;n.forEach(function(n){client.monitorData.session.createdUsers.push({useruin:n.msg.useruin,time:n.msg.createtime,delay:t})})}else monitorSession.start()})},created:function(n,t){var i,r;(monitorSession.start(),i=n.kfcreatesession_resp.where(function(n){return n.base_resp.ret===0}),i.length!==0)&&(toastr.success("接入新客户!"),client.monitorData.session.success+=i.length,r=i.select(function(n){return{useruin:n.kfsession.fans_uin,nickname:n.kfsession.nickname,openid:n.kfsession.fans_openid,sessionid:n.kfsession.session_id,msgid:n.msgsummary.msg.msgid,time:n.kfsession.start_time}}),client.pushSessions(r),r.forEach(function(n){client.monitorData.session.successUsers.push({useruin:n.useruin,time:n.time,delay:t})}),client.settings.auto_reply&&autoReply&&autoReply.sendReply(r))},enable:function(){monitorSession.isEnable=!0;monitorSession.start()},disable:function(){monitorSession.isEnable=!1;monitorSession.timer&&(clearInterval(monitorSession.timer),monitorSession.timer=null)},init:function(){$(".main_header").append('<div class="state" style="top:-100px;top:-50px">                   <input class="tgl tgl-skewed" id="chkMonitor" type="checkbox" />                   <label class="tgl-btn" data-tg-off="关" data-tg-on="开" for="chkMonitor">                   <\/label><\/div>');$(".main_content").css("overflow","visible");$("#chkMonitor").change(function(){var n=$(this).is(":checked");n?monitorSession.enable():monitorSession.disable()})}};$.extend(plug,{getUnAccepted:function(n){plug.get("/cgi-bin/kfunaccepted?action=getmsglist",{count:5,direct:1,dayoption:1},function(t,i){t.base_resp.ret>0?n([],i):n(t.msglist,i)})},createSession:function(n,t,i){var r={fansuinlist:n,isselectall:t?1:0,isauto:0};plug.post("/cgi-bin/kfunaccepted?action=kfbatchcreatesession",r,function(n,t){i(n,t)})}});builder.register(monitorSession.init,10);filter={keywords:client.settings.keywords,init:function(){$("body").on("keydown","#editor",function(n){var i=$("#editor").text(),t;if(n.which===13&&i){if(t=filter.match(i),t)return toastr.error("含有禁止关键字["+t+"]!"),!1;var r=$(".card_selected").data("reactid"),u=r.indexOf("$")+1,f=r.substring(u),e=setTimeout(()=>{monitorMessages.sendData(f,0,10),clearTimeout(e)},1e3)}})},match:function(n){for(var i,t=0;t<filter.keywords.length;t++)if(i=filter.keywords[t],n.indexOf(i)>=0)return i;return null}};builder.register(filter.init,20);autoReply={init:function(){plug.getSettings(function(n){var t=n.config;client.reply_list=t.fastreply_list;client.public_reply_list=n.public_reply.fastreply_list})},sendReply:function(n){n.forEach(function(n){plug.sendReply(n,0,autoReply.sendCompleted)})},sendCompleted:function(n,t){t++;var i=client.settings.auto_count||4;t<i&&plug.sendReply(n,t,autoReply.sendCompleted)}};$.extend(plug,{sendReply:function(n,t,i){if(client.reply_list.length<=t){console.log("自动回复失败,消息索引有误"+t);return}var u=client.reply_list[t],r={isautoreply:0,isfastreply:1,sessionid:n.sessionid,fans_openid:n.openid,msgtype:u.msgtype,content:u.content};r.clientmsgid=window.btoa([r.fans_openid,client.current.kfwx,Date.now(),Math.floor(1e7*Math.random())].join("|"));plug.post("/cgi-bin/kfmsg?action=send",r,function(r){i&&i(n,t,r)})}});builder.register(autoReply.init,20);